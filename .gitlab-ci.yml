stages:
    - lint
    - test
    - build
    - deploy
    
lint-test-job:
    stage: lint
    image: node:20
    script:
        - echo "Linting code..."
        - npm install
        - npm run lint
        - echo "No lint issues found."
        
unit-test-job:
    stage: test
    script:
        - echo "Running unit tests... This will take about 60 seconds."
        - sleep 60
        - echo "Code coverage is 90%"
        
build-job:
    stage: build
    image: node:20
    script:
        - echo "Compiling the code..."
        - npm install
        - npm run build
        - echo "Compile complete."
        
deploy-job:
    stage: deploy
    image: docker:19.03.12
    services:
        - docker:19.03.12-dind
    script:
        - docker info
        - |
            if [ "$CI_COMMIT_BRANCH" == "master" ]; then
                export IMAGE_NAME=production
            elif [ "$CI_COMMIT_BRANCH" == "development" ]; then
                export IMAGE_NAME=staging
            else
                echo "Skipping Docker image build for branch $CI_COMMIT_BRANCH"
                exit 0
            fi
        - docker build -t $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA